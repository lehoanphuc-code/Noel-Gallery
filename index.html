<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magical Christmas Story</title>
    
    <!-- CDNs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* CSS Reset & Base */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #020205; /* Deep dark night */
            overflow: hidden;
            font-family: 'Cinzel', serif;
            color: white;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Canvas Container */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* UI Overlays */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: opacity 1s ease;
            pointer-events: none; /* Default to pass-through */
        }

        /* Start Screen */
        #start-screen {
            background: radial-gradient(circle at center, rgba(20,20,40,0.9), #000);
            pointer-events: auto;
            opacity: 1;
        }

        #start-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        h1 {
            font-family: 'Great Vibes', cursive;
            font-size: 4rem;
            color: #d4af37; /* Gold */
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
            margin-bottom: 20px;
            padding: 0 20px;
        }

        p {
            font-size: 1.2rem;
            color: #ccc;
            margin-bottom: 40px;
            max-width: 600px;
            line-height: 1.6;
            padding: 0 20px;
        }

        .btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            background: transparent;
            border: 2px solid #d4af37;
            color: #d4af37;
            cursor: pointer;
            border-radius: 50px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-family: 'Cinzel', serif;
        }

        .btn:hover {
            background: #d4af37;
            color: #000;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.6);
        }

        /* End Screen */
        #end-screen {
            opacity: 0;
            background: radial-gradient(circle at center, rgba(50,0,0,0.3), transparent);
        }

        #end-screen.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .final-msg {
            font-family: 'Great Vibes', cursive;
            font-size: 5rem;
            color: #ff3333;
            text-shadow: 0 0 30px rgba(255, 50, 50, 0.8), 0 0 60px rgba(255, 255, 255, 0.4);
            animation: float 3s ease-in-out infinite;
            padding: 0 20px;
        }

        .sub-msg {
            font-size: 1.5rem;
            margin-top: 20px;
            color: #fff;
            opacity: 0.8;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            h1 { font-size: 3rem; }
            .final-msg { font-size: 3.5rem; }
            .sub-msg { font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <!-- 3D Container -->
    <div id="canvas-container"></div>

    <!-- Start Screen -->
    <div id="start-screen" class="overlay">
        <h1>A Christmas Story</h1>
        <p>A cinematic journey through memories.<br>Please turn on your sound and tap below to begin.</p>
        <button class="btn" id="start-btn">Start Journey</button>
    </div>

    <!-- End Screen -->
    <div id="end-screen" class="overlay">
        <div class="final-msg">Merry Christmas</div>
        <div class="sub-msg">Wishing you joy, love, and peace.</div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const STORY_CONFIG = {
            // Replace these URLs with your local paths e.g., './assets/images/1.jpg'
            images: [
                'https://picsum.photos/id/1011/600/800', // Winter canoe
                'https://picsum.photos/id/1015/600/800', // River valley
                'https://picsum.photos/id/1016/600/800', // Canyon
                'https://picsum.photos/id/1018/600/800', // Nature
                'https://picsum.photos/id/1022/600/800', // Dark forest
                'https://picsum.photos/id/1039/600/800', // Waterfall
                'https://picsum.photos/id/1043/600/800'  // Colors
            ],
            snowCount: 1500,
            musicUrl: '' // Optional: Add a path to an mp3 here
        };

        // --- GLOBAL VARIABLES ---
        let scene, camera, renderer;
        let snowSystem;
        let imageGroup;
        let mouse = new THREE.Vector2();
        let targetMouse = new THREE.Vector2();
        let windowHalfX = window.innerWidth / 2;
        let windowHalfY = window.innerHeight / 2;
        let isPlaying = false;
        const clock = new THREE.Clock();

        // --- INITIALIZATION ---
        function init() {
            // 1. Scene Setup
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x020205, 0.002); // Deep fog for depth

            // 2. Camera
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;

            // 3. Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Cap at 2x for performance
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // 4. Lighting (Subtle)
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            
            const pointLight = new THREE.PointLight(0xffd700, 1, 50);
            pointLight.position.set(0, 0, 10);
            scene.add(pointLight);

            // 5. Components
            createSnow();
            imageGroup = new THREE.Group();
            scene.add(imageGroup);

            // 6. Event Listeners
            window.addEventListener('resize', onWindowResize, false);
            document.addEventListener('mousemove', onDocumentMouseMove, false);
            document.addEventListener('touchmove', onDocumentTouchMove, { passive: false });
            
            document.getElementById('start-btn').addEventListener('click', startStory);

            // Start Loop
            animate();
        }

        // --- SNOW SYSTEM ---
        function createSnow() {
            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            
            for (let i = 0; i < STORY_CONFIG.snowCount; i++) {
                const x = (Math.random() - 0.5) * 100;
                const y = (Math.random() - 0.5) * 100;
                const z = (Math.random() - 0.5) * 100; // Deep field
                vertices.push(x, y, z);
            }

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));

            // Create a simple circular texture programmatically
            const canvas = document.createElement('canvas');
            canvas.width = 32;
            canvas.height = 32;
            const context = canvas.getContext('2d');
            const gradient = context.createRadialGradient(16, 16, 0, 16, 16, 16);
            gradient.addColorStop(0, 'rgba(255,255,255,1)');
            gradient.addColorStop(1, 'rgba(255,255,255,0)');
            context.fillStyle = gradient;
            context.fillRect(0, 0, 32, 32);
            
            const texture = new THREE.CanvasTexture(canvas);

            const material = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 0.4,
                map: texture,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });

            snowSystem = new THREE.Points(geometry, material);
            scene.add(snowSystem);
        }

        // --- IMAGE MANAGER ---
        class ImageManager {
            constructor(urls) {
                this.urls = urls;
                this.loader = new THREE.TextureLoader();
                this.timeline = gsap.timeline({
                    onComplete: showEnding
                });
            }

            buildSequence() {
                // Subtle camera forward drift
                this.timeline.to(camera.position, {
                    z: 3, // Move from 5 to 3 slowly
                    duration: this.urls.length * 6 + 5,
                    ease: "none"
                }, 0);

                this.urls.forEach((url, index) => {
                    this.createImageFrame(url, index);
                });
            }

            createImageFrame(url, index) {
                // Load texture
                this.loader.load(url, (texture) => {
                    // Aspect ratio correction
                    const aspect = texture.image.width / texture.image.height;
                    const geometry = new THREE.PlaneGeometry(3 * aspect, 3);
                    const material = new THREE.MeshBasicMaterial({ 
                        map: texture, 
                        transparent: true, 
                        opacity: 0,
                        side: THREE.DoubleSide
                    });
                    
                    const mesh = new THREE.Mesh(geometry, material);
                    
                    // Initial Position (Far away in Z, random XY spiral)
                    const angle = index * 2.0; // Spiral angle
                    const radius = 8;
                    const startZ = -60 - (index * 20); // Start deep in background
                    
                    mesh.position.set(
                        Math.cos(angle) * radius,
                        Math.sin(angle) * radius,
                        startZ
                    );
                    
                    // Random initial rotation
                    mesh.rotation.z = (Math.random() - 0.5) * 0.5;
                    mesh.rotation.y = (Math.random() - 0.5) * 0.5;

                    imageGroup.add(mesh);

                    // --- ANIMATION SEQUENCE FOR THIS IMAGE ---
                    // Calculate start time based on index
                    const startTime = index * 5; 

                    // 1. Fly In to "Focus Zone" (near z=0)
                    this.timeline.to(mesh.position, {
                        z: 0,
                        x: 0, // Center
                        y: 0,
                        duration: 6,
                        ease: "power2.out"
                    }, startTime);
                    
                    this.timeline.to(mesh.material, { opacity: 1, duration: 2 }, startTime);

                    // 2. Hover/Read time (Gentle float)
                    this.timeline.to(mesh.rotation, { 
                        z: 0, 
                        y: 0, 
                        duration: 4,
                        ease: "power1.inOut" 
                    }, startTime + 2);

                    // 3. Fly Out (behind camera)
                    this.timeline.to(mesh.position, {
                        z: 10,
                        y: 3, // Fly up and away
                        duration: 3,
                        ease: "power2.in"
                    }, startTime + 7); // Wait before leaving
                    
                    this.timeline.to(mesh.material, { 
                        opacity: 0, 
                        duration: 1 
                    }, startTime + 9);
                });
            }
        }

        // --- APP LOGIC ---

        function startStory() {
            if (isPlaying) return;
            isPlaying = true;
            
            // Hide Start Screen
            const startScreen = document.getElementById('start-screen');
            startScreen.classList.add('hidden');

            // Initialize Image Sequence
            const imgMgr = new ImageManager(STORY_CONFIG.images);
            imgMgr.buildSequence();

            // Optional: Play Audio
            if(STORY_CONFIG.musicUrl) {
                const audio = new Audio(STORY_CONFIG.musicUrl);
                audio.play().catch(e => console.log("Audio autoplay blocked"));
            }
        }

        function showEnding() {
            const endScreen = document.getElementById('end-screen');
            endScreen.classList.add('visible');
            
            // Accelerate snow for finale
            if(snowSystem) {
                gsap.to(snowSystem.rotation, {
                    x: snowSystem.rotation.x + 2,
                    duration: 10,
                    ease: "power1.in"
                });
            }
        }

        // --- EVENTS ---

        function onWindowResize() {
            windowHalfX = window.innerWidth / 2;
            windowHalfY = window.innerHeight / 2;
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onDocumentMouseMove(event) {
            mouse.x = (event.clientX - windowHalfX) / 200; // Sensitivity
            mouse.y = (event.clientY - windowHalfY) / 200;
        }

        function onDocumentTouchMove(event) {
            if (event.touches.length > 0) {
                mouse.x = (event.touches[0].clientX - windowHalfX) / 200;
                mouse.y = (event.touches[0].clientY - windowHalfY) / 200;
            }
        }

        // --- ANIMATION LOOP ---

        function animate() {
            requestAnimationFrame(animate);

            // Smooth Camera Parallax
            targetMouse.x += (mouse.x - targetMouse.x) * 0.05;
            targetMouse.y += (mouse.y - targetMouse.y) * 0.05;
            
            // Apply parallax to camera position (relative to its base movement)
            // We add the offset to the current position which is being tweened by GSAP
            camera.position.x += (targetMouse.x - camera.position.x) * 0.1;
            camera.position.y += (-targetMouse.y - camera.position.y) * 0.1;
            
            // Ensure camera always looks at center
            camera.lookAt(scene.position);

            // Snow Animation
            if (snowSystem) {
                snowSystem.rotation.y += 0.001;
                snowSystem.rotation.z += 0.0005;
            }

            renderer.render(scene, camera);
        }

        // Run Init
        init();

    </script>
</body>
</html>